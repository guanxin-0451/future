## Redis

### 数据结构
- 应用层数据结构
  1. string
  2. hash
  3. List
  4. Set
  5. SortedSet(zset)
- 底层数据结构
    1. 简单动态字符串 SDS
    
       ```
       struct sdshdr {
            //记录buf数组中已使用字节的数量
            //等于SDS所保存字符串的长度
            int len;
            //记录buf数组中未使用字节的数量
            int free;
            //字节数组，用于保存字符串
            char buf[];
        };
       ```
        1. 计算len o（1）
        2. 可以检查空间，选择是否扩容来修改字符串，杜绝缓冲区问题
        3. 解除了字符串长度和数组长度的关联
        4. 预分配空间&惰性空间释放
        预分配：小于1mb的 分配len=free的空间 大于1mb的 分配free  = 1mb
        5. 二进制安全
    
    2. 链表
      1. 双向链表
         - 链表被广泛用于实现Redis的各种功能，比如列表键、发布与订阅、慢查询、监视器等。
         - 每个链表节点由一个listNode结构来表示，每个节点都有一个指向前置节点和后置节点的指针，所以Redis的链表实现是双端链表。
         - 每个链表使用一个list结构来表示，这个结构带有表头节点指针、表尾节点指针，以及链表长度等信息。
         - 因为链表表头节点的前置节点和表尾节点的后置节点都指向NULL，所以Redis的链表实现是无环链表。
         - 通过为链表设置不同的类型特定函数，Redis的链表可以用于保存各种不同类型的值。
    
    
    3.hash
    美团针对Redis Rehash机制的探索和实践
    https://tech.meituan.com/2018/07/27/redis-rehash-practice-optimization.html
    
    
    MurmurHash 算法
    
    
    负载因子：
    当负载因子是1.0的时候，也就意味着，只有当数组的8个值（这个图表示了8个）全部填充了，才会发生扩容。这就带来了很大的问题，因为Hash冲突时避免不了的。当负载因子是1.0的时候，意味着会出现大量的Hash的冲突，底层的红黑树变得异常复杂。对于查询效率极其不利。这种情况就是牺牲了时间来保证空间的利用率。
    因此一句话总结就是负载因子过大，虽然空间利用率上去了，但是时间效率降低了。
    2、负载因子是0.5
    负载因子是0.5的时候，这也就意味着，当数组中的元素达到了一半就开始扩容，既然填充的元素少了，Hash冲突也会减少，那么底层的链表长度或者是红黑树的高度就会降低。查询效率就会增加。
    但是，兄弟们，这时候空间利用率就会大大的降低，原本存储1M的数据，现在就意味着需要2M的空间。
    一句话总结就是负载因子太小，虽然时间效率提升了，但是空间利用率降低了。
    3、负载因子0.75
    经过前面的分析，基本上为什么是0.75的答案也就出来了，这是时间和空间的权衡。当然这个答案不是我自己想出来的。
    
    
    4.跳跃表  sortedset
    Redis只在两个地方用到了跳跃表，一个是实现有序集合键，另一个是在集群节点中用作内部数据结构
    Redis的跳跃表实现由zskiplist和zskiplistNode两个结构组成，其中zskiplist用于保存跳跃表信息（比如表头节点、表尾节点、长度），而zskiplistNode则用于表示跳跃表节点。❑每个跳跃表节点的层高都是1至32之间的随机数。❑在同一个跳跃表中，多个节点可以包含相同的分值，但每个节点的成员对象必须是唯一的。❑跳跃表中的节点按照分值大小进行排序，当分值相同时，节点按照成员对象的大小进行排序。
    
    5.整数集合
    可调整的集合元素类型
    升级
    1）根据新元素的类型，扩展整数集合底层数组的空间大小，并为新元素分配空间。2）将底层数组现有的所有元素都转换成与新元素相同的类型，并将类型转换后的元素放置到正确的位上，而且在放置元素的过程中，需要继续维持底层数组的有序性质不变。3）将新元素添加到底层数组里面。
    降级
    整数集合不支持降级
    
    6.压缩列表（ziplist）是列表键和哈希键的底层实现之一。当一个列表键只包含少量列表项，并且每个列表项要么就是小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列表来做列表键的底层实现
    
    压缩列表是单向的，需要记录首尾，可以从首位遍历
    


### 资料&参考
  [持久化](https://www.cnblogs.com/javazhiyin/p/11425060.html)
  [布隆过滤器](https://juejin.cn/post/6844903982209449991)